name: Deploy Full-Managed Kafka Connectors

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action to perform'
        required: true
        default: 'apply'
        type: choice
        options:
          - apply
          - destroy
          - plan
      CODAPP:
        description: 'codigo de applicaciÃ³n de 4 letras'
        required: true
        type: string

env:
  VAULT_ADDR: "https://peve-vault-cluster-public-vault-792c8051.d71fe7f2.z1.hashicorp.cloud:8200"
  CODAPP: ${{ github.event.inputs.CODAPP }}
  ENVIRONMENT: "DES"
  VAULT_ENV_PATH: "dev"
  TF_VAR_connectors_dir: "../../${{ github.event.inputs.CODAPP }}/ccloud-connectors"
  KAFKA_CLUSTER_ID: "lkc-xxxxx"  # Actualizar con el cluster ID real
  SERVICE_ACCOUNT: "SA_AZC_DES_PEVE_POS_01"  # SA para el API Key de Terraform
  API_KEY_TERRAFORM: "AK_AZC_DES_PEVE_CRMAN_PAYMENT_01"  # API Key de Terraform

jobs:
  deploy-connectors:
    runs-on: ubuntu-latest
    environment: APP_PEVE_CI_DESA  # Actualizar segÃºn entorno
    
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4

      - name: Checkout ${{ env.CODAPP }} resources
        uses: actions/checkout@v4
        with:
          repository: denniskano/test-event-driven-resources
          ref: develop
          path: resources
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Move ${{ env.CODAPP }} to correct location
        run: |
          mv resources/${{ env.CODAPP }} ./${{ env.CODAPP }}
          rm -rf resources
          echo "âœ… ${{ env.CODAPP }} folder moved to workspace root"

      - name: Verify ${{ env.CODAPP }} folder structure
        run: |
          echo "=== Listing workspace root ==="
          ls -la
          echo ""
          echo "=== Listing ${{ env.CODAPP }} folder ==="
          ls -la ${{ env.CODAPP }}/ || echo "${{ env.CODAPP }} folder not found!"
          echo ""
          echo "=== Listing ${{ env.CODAPP }}/ccloud-connectors ==="
          ls -la ${{ env.CODAPP }}/ccloud-connectors/ || echo "ccloud-connectors folder not found!"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"

      - name: Extract Environment ID from CC_PROPERTIES
        id: extract-env
        run: |
          echo "CC_PROPERTIES raw content:"
          echo '${{ vars.CC_PROPERTIES }}'
          
          ENVIRONMENT_ID=$(echo '${{ vars.CC_PROPERTIES }}' | jq -r '.azure_eu2_kafka01.environment_id')
          
          echo "Extracted ENVIRONMENT_ID: '$ENVIRONMENT_ID'"
          
          if [ -z "$ENVIRONMENT_ID" ] || [ "$ENVIRONMENT_ID" == "null" ]; then
            echo "Error: Could not extract environment_id from CC_PROPERTIES"
            exit 1
          fi
          
          echo "ENVIRONMENT_ID=$ENVIRONMENT_ID" >> $GITHUB_ENV
          echo "âœ… Environment ID configured: $ENVIRONMENT_ID"

      - name: Get Terraform Provider Secrets
        id: get-secrets-terraform
        uses: hashicorp/vault-action@v2
        with:
          url: ${{ env.VAULT_ADDR }}
          tlsSkipVerify: true
          method: approle
          namespace: admin
          roleId: ${{ secrets.APP_ROLEID_PEVE_DESA }}
          secretId: ${{ secrets.APP_ROLESECRET_PEVE_DESA }}
          exportToken: true
          secrets: |
            peve/data/${{ env.VAULT_ENV_PATH }}/peve/ccloud/${{ env.SERVICE_ACCOUNT }}/${{ env.API_KEY_TERRAFORM }} username | CONFLUENT_CLOUD_API_KEY ;
            peve/data/${{ env.VAULT_ENV_PATH }}/peve/ccloud/${{ env.SERVICE_ACCOUNT }}/${{ env.API_KEY_TERRAFORM }} password | CONFLUENT_CLOUD_API_SECRET ;

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Fetch connector secrets from Vault
        run: |
          CONNECTORS_DIR="${{ env.CODAPP }}/ccloud-connectors"
          PREFIX="${{ env.VAULT_ENV_PATH }}"
          SECRETS_JSON="{}"

          for connector_dir in $(find "${CONNECTORS_DIR}" -mindepth 1 -maxdepth 1 -type d); do
            connector_name=$(basename "$connector_dir")
            vars_file="${connector_dir}/${PREFIX}-vars.yaml"

            if [ ! -f "$vars_file" ]; then
              echo "â­ï¸  No vars file for ${connector_name}, skipping"
              continue
            fi

            secrets_keys=$(yq '.vault.secrets | keys | .[]' "$vars_file" 2>/dev/null || echo "")

            if [ -z "$secrets_keys" ]; then
              echo "â­ï¸  No vault.secrets for ${connector_name}, skipping"
              continue
            fi

            echo "ðŸ” Fetching secrets for ${connector_name}..."
            connector_secrets="{}"

            while IFS= read -r key; do
              vault_path=$(yq ".vault.secrets.\"${key}\".path" "$vars_file")
              vault_field=$(yq ".vault.secrets.\"${key}\".field" "$vars_file")

              secret_value=$(curl -s \
                -H "X-Vault-Token: ${VAULT_TOKEN}" \
                -H "X-Vault-Namespace: admin" \
                "${VAULT_ADDR}/v1/${vault_path}" | jq -r ".data.data.${vault_field}")

              if [ -z "$secret_value" ] || [ "$secret_value" == "null" ]; then
                echo "âŒ Failed to fetch secret: ${vault_path} -> ${vault_field} for key ${key}"
                exit 1
              fi

              connector_secrets=$(echo "$connector_secrets" | jq --arg k "$key" --arg v "$secret_value" '. + {($k): $v}')
              echo "  âœ… ${key} fetched successfully"
            done <<< "$secrets_keys"

            SECRETS_JSON=$(echo "$SECRETS_JSON" | jq --arg cn "$connector_name" --argjson cs "$connector_secrets" '. + {($cn): $cs}')
          done

          echo "CONNECTOR_SECRETS=${SECRETS_JSON}" >> $GITHUB_ENV
          echo "âœ… All connector secrets fetched"

      - name: Terraform Init - Connectors
        working-directory: terraform/ccloud-connectors
        run: |
          terraform init \
            -backend-config="storage_account_name=pevetfstate" \
            -backend-config="resource_group_name=rg-peve-terraform" \
            -backend-config="container_name=tf-connectors-${{ env.VAULT_ENV_PATH }}" \
            -backend-config="key=${{ env.VAULT_ENV_PATH }}/${{ env.CODAPP }}/tf-connectors.tfstate" \
            -backend-config="access_key=${{ secrets.ARM_ACCESS_KEY }}"

      - name: Terraform Plan - Connectors
        working-directory: terraform/ccloud-connectors
        run: terraform plan
        if: github.event.inputs.action != 'destroy'
        env:
          TF_VAR_environment_id: ${{ env.ENVIRONMENT_ID }}
          TF_VAR_connectors_dir: ${{ env.TF_VAR_connectors_dir }}
          TF_VAR_kafka_cluster_id: ${{ env.KAFKA_CLUSTER_ID }}
          TF_VAR_environment: ${{ env.ENVIRONMENT }}
          TF_VAR_confluent_cloud_api_key: ${{ env.CONFLUENT_CLOUD_API_KEY }}
          TF_VAR_confluent_cloud_api_secret: ${{ env.CONFLUENT_CLOUD_API_SECRET }}
          TF_VAR_connector_secrets: ${{ env.CONNECTOR_SECRETS }}

      - name: Terraform Apply - Connectors
        working-directory: terraform/ccloud-connectors
        run: terraform apply -auto-approve
        if: github.event.inputs.action == 'apply'
        env:
          TF_VAR_environment_id: ${{ env.ENVIRONMENT_ID }}
          TF_VAR_connectors_dir: ${{ env.TF_VAR_connectors_dir }}
          TF_VAR_kafka_cluster_id: ${{ env.KAFKA_CLUSTER_ID }}
          TF_VAR_environment: ${{ env.ENVIRONMENT }}
          TF_VAR_confluent_cloud_api_key: ${{ env.CONFLUENT_CLOUD_API_KEY }}
          TF_VAR_confluent_cloud_api_secret: ${{ env.CONFLUENT_CLOUD_API_SECRET }}
          TF_VAR_connector_secrets: ${{ env.CONNECTOR_SECRETS }}

      - name: Terraform Destroy - Connectors
        working-directory: terraform/ccloud-connectors
        run: terraform destroy -auto-approve
        if: github.event.inputs.action == 'destroy'
        env:
          TF_VAR_environment_id: ${{ env.ENVIRONMENT_ID }}
          TF_VAR_connectors_dir: ${{ env.TF_VAR_connectors_dir }}
          TF_VAR_kafka_cluster_id: ${{ env.KAFKA_CLUSTER_ID }}
          TF_VAR_environment: ${{ env.ENVIRONMENT }}
          TF_VAR_confluent_cloud_api_key: ${{ env.CONFLUENT_CLOUD_API_KEY }}
          TF_VAR_confluent_cloud_api_secret: ${{ env.CONFLUENT_CLOUD_API_SECRET }}
          TF_VAR_connector_secrets: ${{ env.CONNECTOR_SECRETS }}

      - name: Output Connectors
        working-directory: terraform/ccloud-connectors
        run: |
          if [ "${{ github.event.inputs.action }}" == "apply" ]; then
            echo "=== Connectors Deployed ==="
            terraform output -json connectors || echo "No connectors found"
          fi
